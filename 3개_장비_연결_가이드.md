# 3개 장비 네트워크 연결 가이드

## 시스템 개요

이 문서는 PLC Simulator, Edge AI Computer, HMI V1을 각각의 독립된 PC에 설치하고 유선 LAN으로 연결하는 방법을 설명합니다.

---

## 시스템 아키텍처

```
┌─────────────────┐
│   PLC Simulator │ (192.168.1.10)
│   (PC #1)       │
└────────┬────────┘
         │ LAN Cable (이더넷)
         │
    ┌────┴────────────────────┐
    │    네트워크 스위치        │
    └────┬────────────────┬───┘
         │                │
┌────────┴────────┐  ┌───┴──────────┐
│  Edge AI        │  │   HMI V1     │
│  Computer       │  │   (PC #3)    │
│  (PC #2)        │  │              │
│  192.168.1.20   │  │ 192.168.1.30 │
└─────────────────┘  └──────────────┘
```

---

## 하드웨어 연결 방법

### 방법 1: 스위치/허브 사용 (권장)

**장점:**
- 설정이 간단
- 확장성 좋음 (나중에 장비 추가 용이)
- 안정적

**필요 장비:**
- 이더넷 스위치 (4포트 이상) × 1개
- 이더넷 케이블 (CAT5e 이상) × 3개

**연결 방법:**
1. 스위치를 중앙에 배치
2. PLC Simulator PC → 스위치 포트 1
3. Edge Computer PC → 스위치 포트 2
4. HMI PC → 스위치 포트 3

---

### 방법 2: 직접 연결 (고급)

PLC Simulator PC에 **네트워크 카드 2개** 필요

**연결:**
- PLC LAN 포트 1 → Edge Computer (크로스오버 케이블)
- PLC LAN 포트 2 → HMI (크로스오버 케이블)

**주의:** 최신 네트워크 카드는 Auto-MDIX 기능으로 일반 케이블도 사용 가능

---

## 네트워크 IP 설정

### PC #1: PLC Simulator

**IP 설정:**
- IP 주소: `192.168.1.10`
- 서브넷 마스크: `255.255.255.0`
- 게이트웨이: 비워둠 (로컬 네트워크만 사용)

**설정 방법:**
1. 제어판 → 네트워크 및 공유 센터
2. 어댑터 설정 변경
3. 사용하는 이더넷 어댑터 우클릭 → 속성
4. Internet Protocol Version 4 (TCP/IPv4) 선택 → 속성
5. "다음 IP 주소 사용" 선택 후 위 정보 입력

**방화벽 설정:**
```batch
netsh advfirewall firewall add rule name="Modbus TCP" dir=in action=allow protocol=TCP localport=502
```

---

### PC #2: Edge AI Computer

**IP 설정:**
- IP 주소: `192.168.1.20`
- 서브넷 마스크: `255.255.255.0`
- 게이트웨이: 비워둠

**프로그램 설정:**

**방법 1: 환경 변수 사용 (권장)**
```batch
set PLC_HOST=192.168.1.10
set PLC_PORT=502
set PLC_SLAVE_ID=3
cd C:\Users\my\Desktop\Edge_Computer_V1
START.bat
```

**방법 2: config.py 수정**
`C:\Users\my\Desktop\Edge_Computer_V1\config.py` 파일 열기:
```python
# PLC 연결 설정
PLC_HOST = "192.168.1.10"  # localhost → PLC IP로 변경
PLC_PORT = 502
PLC_SLAVE_ID = 3
```

---

### PC #3: HMI V1

**IP 설정:**
- IP 주소: `192.168.1.30`
- 서브넷 마스크: `255.255.255.0`
- 게이트웨이: 비워둠

**프로그램 설정:**

**방법 1: 환경 변수 사용 (권장)**
```batch
set PLC_HOST=192.168.1.10
set PLC_PORT=502
set PLC_SLAVE_ID=3
cd C:\Users\my\Desktop\HMI_V1
START_HMI_V1.bat
```

**방법 2: main.py 수정**
`C:\Users\my\Desktop\HMI_V1\backend\main.py` 파일에서 (약 40번째 줄):
```python
plc_client = PLCClient(
    host="192.168.1.10",      # PLC IP 지정
    port=502,
    slave_id=3,
    use_simulation=False      # 중요: 시뮬레이션 모드 끄기!
)
```

---

## 시작 절차

### 1단계: 네트워크 연결 확인

**PLC Simulator PC에서:**
```batch
ipconfig
```
→ IP 주소가 192.168.1.10인지 확인

**Edge Computer PC에서:**
```batch
ping 192.168.1.10
```
→ 응답 오는지 확인

**HMI PC에서:**
```batch
ping 192.168.1.10
```
→ 응답 오는지 확인

---

### 2단계: 프로그램 순차 시작

**중요: 반드시 아래 순서대로 시작해야 합니다!**

#### ① PLC Simulator 시작 (PC #1)
```batch
cd C:\Users\my\Desktop\PLC_Simulator
START.bat
```

**확인 사항:**
- "Modbus TCP Server 시작 완료" 메시지
- "Listening on 0.0.0.0:502" 표시

**대기 시간:** 5초

---

#### ② Edge AI Computer 시작 (PC #2)
```batch
set PLC_HOST=192.168.1.10
cd C:\Users\my\Desktop\Edge_Computer_V1
START.bat
```

**확인 사항:**
- "PLC 연결 성공 (192.168.1.10:502)" 메시지
- "AI 계산 시작" 메시지
- 에러 없이 1초마다 로그 출력

**대기 시간:** 10초

---

#### ③ HMI V1 시작 (PC #3)
```batch
set PLC_HOST=192.168.1.10
cd C:\Users\my\Desktop\HMI_V1
START_HMI_V1.bat
```

**확인 사항:**
- Backend: "PLC 연결 성공" 메시지
- Frontend: 자동으로 브라우저 열림
- 브라우저 주소: http://localhost:5173
- 대시보드에 실시간 데이터 표시

---

## 종료 절차

**역순으로 종료:**

1. HMI 종료 (PC #3)
   - Frontend 브라우저 창 닫기
   - Backend 터미널에서 Ctrl+C

2. Edge Computer 종료 (PC #2)
   - 터미널에서 Ctrl+C

3. PLC Simulator 종료 (PC #1)
   - 터미널에서 Ctrl+C

**또는 HMI PC에서 일괄 종료:**
```batch
cd C:\Users\my\Desktop\HMI_V1
STOP_HMI.bat
```
(단, 이 방법은 HMI와 같은 PC에서 실행 중인 프로세스만 종료합니다)

---

## 트러블슈팅

### 문제 1: Edge Computer가 PLC에 연결 실패

**증상:**
```
[ERROR] PLC 연결 실패
[ERROR] Connection timeout
```

**해결 방법:**
1. PLC Simulator가 정상 실행 중인지 확인
2. 방화벽 설정 확인 (PLC PC에서 포트 502 열기)
3. IP 주소 확인:
   ```batch
   ping 192.168.1.10
   ```
4. 네트워크 케이블 연결 상태 확인

---

### 문제 2: HMI 브라우저에 데이터가 표시되지 않음

**증상:**
- 브라우저는 열리지만 빈 화면
- 콘솔에 에러 표시

**해결 방법:**
1. Backend 로그 확인:
   - "PLC 연결 성공" 메시지 있는지 확인
2. use_simulation=False로 설정했는지 확인
3. PLC_HOST 환경 변수 설정 확인
4. 브라우저 새로고침 (Ctrl+F5)

---

### 문제 3: 네트워크 속도 느림

**원인:**
- 스위치 성능 부족
- 케이블 품질 불량

**해결 방법:**
1. 기가비트(1000Mbps) 스위치 사용
2. CAT6 이상 케이블 사용
3. 케이블 길이 최소화 (50m 이내)

---

## 설정 요약표

| 항목 | PC #1 (PLC) | PC #2 (Edge AI) | PC #3 (HMI) |
|------|-------------|-----------------|-------------|
| **역할** | PLC Simulator | Edge AI Computer | HMI V1 |
| **IP 주소** | 192.168.1.10 | 192.168.1.20 | 192.168.1.30 |
| **서브넷** | 255.255.255.0 | 255.255.255.0 | 255.255.255.0 |
| **방화벽** | 포트 502 열기 | 설정 불필요 | 설정 불필요 |
| **환경 변수** | - | PLC_HOST=192.168.1.10 | PLC_HOST=192.168.1.10 |
| **시뮬레이션** | - | - | use_simulation=False |
| **시작 순서** | 1번째 | 2번째 | 3번째 |

---

## 포트 정보

| 서비스 | 포트 | 프로토콜 | 설명 |
|--------|------|----------|------|
| Modbus TCP | 502 | TCP | PLC Simulator ↔ Edge AI, HMI |
| HMI Backend | 8000 | HTTP | Frontend ↔ Backend (HMI 내부) |
| HMI Frontend | 5173 | HTTP | 브라우저 접속 (HMI 내부) |

---

## 데이터 흐름

```
┌─────────────┐
│ PLC         │
│ - 센서 데이터│ (레지스터 10-19)
│ - 장비 상태 │ (레지스터 4000-4001)
│ - VFD 데이터│ (레지스터 160-239)
└──────┬──────┘
       │ ① 읽기
       ↓
┌─────────────┐
│ Edge AI     │
│ - AI 계산   │
│ - 에너지 절감│
│ - VFD 진단  │
└──────┬──────┘
       │ ② 쓰기
       ↓
┌─────────────┐
│ PLC         │
│ - AI 목표값 │ (레지스터 5000-5009)
│ - 절감 전력 │ (레지스터 5100-5109)
│ - 진단 점수 │ (레지스터 5200-5209)
│ - 절감률    │ (레지스터 5300-5303)
└──────┬──────┘
       │ ③ 읽기 (센서 + Edge AI 결과)
       ↓
┌─────────────┐
│ HMI         │
│ - 시각화    │
│ - 모니터링  │
└─────────────┘
```

---

## 실제 PLC 연결 시 (향후)

PLC Simulator를 실제 PLC로 교체할 때:

1. **PLC IP 주소 확인** (예: 192.168.1.100)
2. **Edge AI config.py 수정:**
   ```python
   PLC_HOST = "192.168.1.100"  # 실제 PLC IP
   ```
3. **HMI 환경 변수 변경:**
   ```batch
   set PLC_HOST=192.168.1.100
   ```
4. **PLC Simulator 프로그램 종료**

→ 나머지 절차는 동일합니다!

---

## 참고 사항

### 보안
- 이 시스템은 **로컬 네트워크 전용**입니다
- 인터넷 연결 시 보안 설정 필요
- VPN 사용 권장 (원격 접속 시)

### 백업
정기적으로 백업 권장:
- `C:\Users\my\Desktop\PLC_Simulator`
- `C:\Users\my\Desktop\Edge_Computer_V1`
- `C:\Users\my\Desktop\HMI_V1`

### 로그 파일 위치
- Edge AI: `C:\Users\my\Desktop\Edge_Computer_V1\edge_ai.log`
- HMI Backend: 콘솔 출력만 (파일 저장 안 함)

---

## 문의

시스템 관리자에게 문의하세요.

**작성일:** 2025년 1월
**버전:** 1.0
